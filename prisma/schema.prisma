// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") 
}

enum ReferralSource {
  AMIGOS
  COMPANEROS
  INTERNET
  OTRO
}
enum Teacher {
  NURIA
  SANTI
}


model Student {
  id             String            @id @default(cuid())
  fullName       String
  phone          String?
  address        String?
  guardianName   String?
  guardianPhone  String?
  school         String?
  course         String
  specialty      String?
  schoolSchedule String?
  referralSource ReferralSource?
  billingRateEurHour  Float?
  desiredHours   Int?
  sessionDurMin  Int?
  extras         Extracurricular[]
  subjects       Subject[] 
  lessons        Lesson[]
  invoice        Invoice[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  @@index([course])
}

model Subject {
  id        String  @id @default(cuid())
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  name      String
  @@index([studentId])
}

model Extracurricular {
  id        String  @id @default(cuid())
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  label     String
  dayOfWeek Int
  startMin  Int
  durMin    Int
  @@index([studentId, dayOfWeek])
}

model WeekState {
  weekStart DateTime @id            // Lunes (00:00) de esa semana
  saved     Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lesson {
  id        String   @id @default(cuid())
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  teacher   Teacher  @default(NURIA)
  dayOfWeek Int
  startMin  Int
  durMin    Int
  actualStartMin Int?
  actualDurMin   Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  weekStart DateTime?

  @@index([weekStart, dayOfWeek, startMin, teacher])
  @@index([studentId, dayOfWeek, startMin])
  @@index([teacher, dayOfWeek, startMin])
}


model Invoice {
  id         String   @id @default(cuid())
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId  String

  /// Formato "YYYY-MM" (ej: "2025-08")
  yearMonth  String

  /// Tarifa aplicada ese mes (â‚¬/h)
  rate       Float

  /// Ajuste manual en minutos (puede ser negativo)
  adjustMin  Int      @default(0)

  /// Minutos totales facturados del mes (planificados + ajuste)
  totalMin   Int

  /// Importe total del recibo (EUR)
  amount     Float

  /// Estado del cobro
  status     String   @default("PENDIENTE") // PENDIENTE | ENVIADO | PAGADO

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([studentId])
  @@index([yearMonth])
  @@unique([studentId, yearMonth]) // un recibo por alumno y mes
}

